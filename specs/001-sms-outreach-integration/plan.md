# Implementation Plan: SMS Outreach Integration

**Branch**: `001-sms-outreach-integration` | **Date**: 2025-11-28 (Updated: 2025-12-08) | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-sms-outreach-integration/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command and filled with actual technical details on 2025-12-08.

## Summary

This feature enables care coordinators to manage patient SMS conversations through a dedicated interface integrated with the SleepConnect platform via Next.js multi-zones architecture. The system provides real-time bi-directional SMS messaging using Twilio Messaging API (Programmable SMS), reusable message templates with dynamic variables, complete conversation history, and analytics for engagement tracking. Data persistence is handled via AWS Lambda functions with PostgreSQL on RDS (no DynamoDB), and the application is deployed as a standalone Next.js zone at `/outreach` with assets served from `/outreach-static/`.

## Technical Context

**Language/Version**: TypeScript 5.x, JavaScript (ES2022+)  
**Primary Dependencies**: Next.js 14.2.25, React 18.2.0, React Query 5.90.12, Twilio SDK 5.10.6, Auth0 Next.js SDK 3.5.0, Flowbite React 0.7.2, Tailwind CSS 3.x, Lucide React 0.309.0  
**Storage**: PostgreSQL on AWS RDS (via AWS Lambda functions, NO DynamoDB per ADR-001)  
**Testing**: Jest 29.5.x (unit), React Testing Library 14.1.2 (integration), Playwright 1.41.0 (E2E)  
**Target Platform**: AWS Lambda (OpenNext), CloudFront CDN, S3 static assets, Modern browsers (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)  
**Project Type**: Web application (Next.js App Router multi-zone)  
**Performance Goals**: LCP < 2.5s, FID < 100ms, CLS < 0.1 (Core Web Vitals per NFR-001), Conversation list loads < 2 seconds with 500+ messages (SC-007), Patient replies appear within 3 seconds (SC-002)  
**Constraints**: API response time < 200ms p95, HIPAA-compliant PHI handling (encryption at rest + in transit, audit logging), US phone numbers only (+1 format), 100-500 messages/day/coordinator expected volume  
**Scale/Scope**: 100 concurrent active conversations per coordinator (SC-008), 500+ message conversation history support, Multi-tenant (tenant_id + practice_id scoping), Independent deployment from SleepConnect main app

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| **I. Data Retention** | ✅ PASS | All entities use soft-delete (archived_on, active flags). FR-014 explicit. data-model.md includes retention policy. |
| **II. Patient-First Privacy & Security** | ✅ PASS | FR-035-038 cover encryption, audit, TLS, BAA. HIPAA compliance throughout. |
| **III. Spec-Driven Development** | ✅ PASS | Constitution → spec.md → plan.md (this file) → tasks.md → implementation workflow followed. |
| **IV. Clear, Maintainable Code** | ✅ PASS | Testing tasks exist (T013 Jest config, E2E tests Phase 3 checklist). Component modularity enforced. |
| **V. Comprehensive Documentation** | ✅ PASS | spec.md, plan.md, research.md, data-model.md, quickstart.md, contracts/sms-api.yaml complete. |
| **VI. Consistent Code Quality** | ✅ PASS | T009 ESLint/Prettier configured. package.json has lint scripts. Biome patterns from sleepconnect. |
| **VII. UTC Timestamp Storage** | ✅ PASS | FR-008b explicit. T019a lib/datetime.ts for UTC→local conversion. data-model.md uses TIMESTAMPTZ. |
| **VIII. Documentation Organization** | ✅ PASS | All docs in specs/001-sms-outreach-integration/ per convention. |

**Result**: All principles satisfied. No violations to justify.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
twilio-conversations-react/ (Outreach Zone)
├── app/                          # Next.js App Router pages
│   ├── layout.tsx               # Root layout with Auth0 + shell integration
│   ├── page.tsx                 # Homepage (redirects to /conversations)
│   ├── providers.tsx            # React Query + theme providers
│   ├── api/outreach/            # Backend API routes
│   │   ├── conversations/       # Conversation CRUD + messages
│   │   ├── templates/           # Template management
│   │   ├── analytics/           # SLA + engagement metrics
│   │   └── webhook/             # Twilio inbound webhook
│   ├── conversations/           # Conversation UI pages
│   │   ├── page.tsx            # List view
│   │   └── [id]/page.tsx       # Detail view
│   ├── templates/               # Template management pages
│   └── analytics/               # Analytics dashboard
│
├── components/                   # React UI components
│   ├── conversations/           # Messaging UI
│   │   ├── ConversationList.tsx
│   │   ├── ConversationDetail.tsx
│   │   ├── MessageBubble.tsx
│   │   ├── MessageComposer.tsx
│   │   ├── PatientContextHeader.tsx
│   │   ├── LinkPatientButton.tsx
│   │   └── ConversationFilter.tsx
│   ├── templates/               # Template UI
│   ├── analytics/               # Analytics charts
│   ├── layout/                  # Shell components
│   │   └── SleepConnectShell.tsx
│   └── ui/                      # Shared UI (shadcn/flowbite)
│
├── hooks/                        # Custom React hooks
│   ├── useConversations.ts      # React Query for conversations
│   ├── useMessages.ts           # React Query for messages
│   └── useTemplates.ts          # React Query for templates
│
├── lib/                          # Utilities and configurations
│   ├── api.ts                   # Axios client + error handling
│   ├── auth.ts                  # Auth0 session utilities
│   ├── twilio.ts                # Twilio client config
│   ├── datetime.ts              # UTC→local timezone conversion
│   ├── format.ts                # Patient DOB, timestamp formatters
│   ├── validation.ts            # Phone number validation
│   └── utils.ts                 # cn() class merger
│
├── types/                        # TypeScript definitions
│   └── sms.ts                   # Conversation, Message, Template types
│
├── tests/                        # Test suites
│   ├── unit/                    # Jest unit tests
│   ├── integration/             # React Testing Library
│   └── e2e/                     # Playwright E2E
│
├── specs/001-sms-outreach-integration/  # Feature documentation
│   ├── spec.md                  # Requirements
│   ├── plan.md                  # This file
│   ├── tasks.md                 # Implementation tasks
│   ├── research.md              # Technology decisions
│   ├── data-model.md            # Database schema
│   ├── quickstart.md            # Setup guide
│   └── contracts/sms-api.yaml   # OpenAPI spec
│
├── public/                       # Static assets
├── .specify/                     # Speckit templates
├── next.config.mjs              # Multi-zone config (basePath: /outreach)
├── tailwind.config.ts           # Tailwind + Flowbite
└── package.json                 # Dependencies
```

**Structure Decision**: Next.js App Router web application with server-side API routes. Backend logic lives in `app/api/outreach/` but delegates data persistence to AWS Lambda functions (external to this repo, managed in sleepconnect/sax-backend). Frontend components in `components/`, organized by feature area (conversations, templates, analytics). Types in `types/sms.ts` shared across client and server. Testing follows Next.js conventions with Jest (unit), RTL (integration), Playwright (E2E).

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
